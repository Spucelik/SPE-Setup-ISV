# SPE-Setup-ISV
Step by step guidance for ISV's to configure your application in a customers tenant.

## SharePoint Embedded Token Generator

This repository contains a PowerShell script to generate certificate-based access tokens for registering SharePoint Embedded owning applications in consuming tenants.

### Prerequisites

- PowerShell 5.1 or later
- Administrator rights (for certificate creation)
- Azure AD app registration with certificate-based authentication configured
- Internet connectivity to reach Azure AD endpoints

### Quick Start

#### Option 1: Create a New Certificate and Generate Token

```powershell
.\New-SharePointEmbeddedToken.ps1 -TenantId "contoso.onmicrosoft.com" -ClientId "12345678-1234-1234-1234-123456789012"
```

This will:
1. Create a new self-signed certificate
2. Store it in the Current User certificate store
3. Generate an access token using the certificate
4. Display the token and certificate details

#### Option 2: Use an Existing Certificate

```powershell
.\New-SharePointEmbeddedToken.ps1 -TenantId "contoso.onmicrosoft.com" -ClientId "12345678-1234-1234-1234-123456789012" -CertificateThumbprint "ABC123DEF456..."
```

#### Option 3: Create Certificate and Export for Distribution

```powershell
.\New-SharePointEmbeddedToken.ps1 -TenantId "contoso.onmicrosoft.com" -ClientId "12345678-1234-1234-1234-123456789012" -ExportCertificate -CertificatePath "C:\Certs"
```

This will export both:
- `.pfx` file (certificate with private key) - for backup and authentication
- `.cer` file (public certificate) - for uploading to Azure AD

### Parameters

| Parameter | Required | Description |
|-----------|----------|-------------|
| `TenantId` | Yes | The Azure AD Tenant ID (GUID or domain name like contoso.onmicrosoft.com) |
| `ClientId` | Yes | The Application (Client) ID of your SharePoint Embedded app |
| `CertificateThumbprint` | No | Thumbprint of an existing certificate to use |
| `CertificateSubject` | No | Subject name for new certificate (default: "CN=SharePointEmbeddedApp") |
| `CertificatePassword` | No | Password to protect the exported certificate |
| `ExportCertificate` | No | Switch to export the certificate to files |
| `CertificatePath` | No | Directory path for certificate export (default: current directory) |

### Setup Steps for ISVs

#### 1. Register Your Application in Azure AD (Owning Tenant)

1. Go to [Azure Portal](https://portal.azure.com)
2. Navigate to Azure Active Directory > App registrations
3. Create a new registration or select your existing SharePoint Embedded app
4. Note your **Application (Client) ID**

#### 2. Configure Certificate Authentication

1. In your app registration, go to "Certificates & secrets"
2. Click "Upload certificate"
3. Upload the `.cer` file generated by this script
4. Note the certificate thumbprint

#### 3. Configure API Permissions

Add the following Microsoft Graph API permissions:
- `Sites.FullControl.All` (Application permission)
- `Files.ReadWrite.All` (Application permission)

Grant admin consent for these permissions.

#### 4. Generate Token for Consuming Tenant

When registering your app in a customer's (consuming) tenant:

```powershell
.\New-SharePointEmbeddedToken.ps1 `
    -TenantId "customer-tenant.onmicrosoft.com" `
    -ClientId "your-app-client-id" `
    -CertificateThumbprint "your-certificate-thumbprint"
```

#### 5. Use the Token

The script will output an access token. Use this token in your API calls:

```http
Authorization: Bearer <access_token>
```

### Token Information

- **Token Type**: Bearer
- **Validity**: Typically 3600 seconds (1 hour)
- **Scope**: `https://graph.microsoft.com/.default`

### Security Best Practices

1. **Certificate Storage**: Store certificates securely. Use the Windows Certificate Store or Azure Key Vault.
2. **Private Key Protection**: Never share `.pfx` files. Only distribute `.cer` (public key) files.
3. **Certificate Rotation**: Regularly rotate certificates (recommended: every 12-24 months).
4. **Access Control**: Limit who can access certificates and run this script.
5. **Token Handling**: Treat tokens as sensitive credentials. Use HTTPS for all API calls.

### Troubleshooting

#### "Certificate with thumbprint not found"
- Ensure the certificate is installed in either Current User or Local Machine certificate store
- Verify the thumbprint is correct (no extra spaces or characters)

#### "Failed to get access token"
- Verify the certificate is uploaded to your Azure AD app registration
- Check that the Client ID and Tenant ID are correct
- Ensure the app has the required API permissions with admin consent
- Verify the certificate has not expired

#### "Certificate does not have a private key"
- The certificate must have an exportable private key
- Re-create the certificate using this script with the `-ExportCertificate` flag

#### "Access denied" or "Insufficient privileges"
- Run PowerShell as Administrator
- Check that API permissions are granted with admin consent
- Verify the app is properly registered in the target tenant

### Examples

#### Example 1: First-Time Setup
```powershell
# Create certificate and export it
.\New-SharePointEmbeddedToken.ps1 `
    -TenantId "mycompany.onmicrosoft.com" `
    -ClientId "12345678-1234-1234-1234-123456789012" `
    -ExportCertificate `
    -CertificatePath "C:\SPE-Certs"

# Upload the .cer file to Azure AD
# Save the thumbprint for future use
```

#### Example 2: Generate Token for Customer Tenant
```powershell
# Use existing certificate to get token for customer
.\New-SharePointEmbeddedToken.ps1 `
    -TenantId "customer.onmicrosoft.com" `
    -ClientId "12345678-1234-1234-1234-123456789012" `
    -CertificateThumbprint "A1B2C3D4E5F6..."
```

#### Example 3: Automated Pipeline
```powershell
# Generate token and capture it for use in scripts
$tokenResponse = .\New-SharePointEmbeddedToken.ps1 `
    -TenantId "customer.onmicrosoft.com" `
    -ClientId "12345678-1234-1234-1234-123456789012" `
    -CertificateThumbprint "A1B2C3D4E5F6..."

# Use the token in API calls
$headers = @{
    "Authorization" = "Bearer $($tokenResponse.access_token)"
    "Content-Type" = "application/json"
}

Invoke-RestMethod -Uri "https://graph.microsoft.com/v1.0/sites" -Headers $headers
```

### Support and Contributing

For issues, questions, or contributions, please contact the repository maintainers or submit an issue on GitHub.

### License

This script is provided as-is for use by ISVs implementing SharePoint Embedded solutions.
